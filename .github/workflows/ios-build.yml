name: iOS Build (Unsigned + Manual Signing)

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Capacitor iOS
      run: npm install @capacitor/ios

    - name: Build web app
      run: npm run build

    - name: Copy web assets to iOS
      run: |
        npx cap copy ios
        npx cap sync ios

    - name: Install CocoaPods dependencies
      run: |
        cd ios/App
        pod install

    - name: Build iOS Archive (No Signing)
      run: |
        cd ios/App
        xcodebuild -workspace App.xcworkspace \
                   -scheme App \
                   -configuration Release \
                   -destination generic/platform=iOS \
                   -archivePath App.xcarchive \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO \
                   archive

    - name: Create Unsigned IPA
      run: |
        cd ios/App
        
        echo "ğŸ“¦ Archive ë‚´ìš© í™•ì¸:"
        ls -la App.xcarchive/Products/Applications/
        
        echo "ğŸ”¨ ë¬´ì„œëª… IPA ìƒì„± ì¤‘..."
        mkdir -p Payload
        cp -r App.xcarchive/Products/Applications/App.app Payload/
        zip -r App-unsigned.ipa Payload/
        
        echo "âœ… ë¬´ì„œëª… IPA ìƒì„± ì™„ë£Œ!"
        ls -lh *.ipa

    - name: Manual Code Signing (Optional)
      env:
        IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
      run: |
        cd ios/App
        
        # ì¸ì¦ì„œì™€ í”„ë¡œí•„ì´ ìˆìœ¼ë©´ ì„œëª… ì‹œë„
        if [ ! -z "$IOS_CERTIFICATE_BASE64" ] && [ ! -z "$IOS_PROVISIONING_PROFILE_BASE64" ]; then
          echo "ğŸ” ìˆ˜ë™ ì„œëª… ì‹œë„ ì¤‘..."
          
          # ì¸ì¦ì„œ ì„¤ì •
          echo $IOS_CERTIFICATE_BASE64 | base64 --decode > certificate.cer
          echo $IOS_PROVISIONING_PROFILE_BASE64 | base64 --decode > profile.mobileprovision
          
          # í‚¤ì²´ì¸ ì„¤ì •
          security create-keychain -p "" build.keychain || true
          security import certificate.cer -k build.keychain -A || true
          security list-keychains -s build.keychain || true
          security default-keychain -s build.keychain || true
          security unlock-keychain -p "" build.keychain || true
          
          # í”„ë¡œë¹„ì €ë‹ í”„ë¡œí•„ ì„¤ì¹˜
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/ || true
          
          # ì„œëª…ëœ IPA ìƒì„± ì‹œë„
          xcodebuild -exportArchive \
                     -archivePath App.xcarchive \
                     -exportPath . \
                     -exportOptionsPlist ../../ExportOptions.plist || echo "ì„œëª… ì‹¤íŒ¨ - ë¬´ì„œëª… IPA ì‚¬ìš©"
        else
          echo "âš ï¸ ì¸ì¦ì„œ ì •ë³´ ì—†ìŒ - ë¬´ì„œëª… IPAë§Œ ìƒì„±"
        fi

    - name: Upload to App Store Connect (If Signed)
      env:
        APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
      run: |
        cd ios/App
        
        # ì„œëª…ëœ IPAê°€ ìˆìœ¼ë©´ ì—…ë¡œë“œ
        if [ -f "App.ipa" ]; then
          echo "ğŸš€ App Store Connect ì—…ë¡œë“œ ì¤‘..."
          echo "$APP_STORE_CONNECT_API_KEY" > AuthKey_$APP_STORE_CONNECT_KEY_ID.p8
          
          xcrun altool --upload-app \
                       --type ios \
                       --file App.ipa \
                       --apiKey $APP_STORE_CONNECT_KEY_ID \
                       --apiIssuer $APP_STORE_CONNECT_ISSUER_ID \
                       --apiKeyPath ./AuthKey_$APP_STORE_CONNECT_KEY_ID.p8 || echo "ì—…ë¡œë“œ ì‹¤íŒ¨"
        else
          echo "âš ï¸ ì„œëª…ëœ IPA ì—†ìŒ - ì—…ë¡œë“œ ê±´ë„ˆëœ€"
        fi

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-builds
        path: |
          ios/App/App-unsigned.ipa
          ios/App/App.ipa
        retention-days: 30
