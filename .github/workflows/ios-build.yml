name: iOS Build and Deploy

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Capacitor iOS
      run: |
        npm install @capacitor/ios
        # iOS í”Œë«í¼ì´ ì—†ì„ ë•Œë§Œ ì¶”ê°€
        if [ ! -d "ios" ]; then
        npx cap add ios
        fi
        
    - name: Build web app
      run: npm run build
      
    - name: Copy web assets to iOS
      run: |
        npx cap copy ios
        npx cap sync ios
        
    - name: Install CocoaPods dependencies
      run: |
        cd ios/App
        pod install
        
      # - name: Setup iOS certificates
    #   env:
    #     IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
    #     IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
    #     IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
    #   run: |
    #     # ì¸ì¦ì„œ ì„¤ì • ìŠ¤í¬ë¦½íŠ¸
    #     echo $IOS_CERTIFICATE_BASE64 | base64 --decode > certificate.p12
    #     echo $IOS_PROVISIONING_PROFILE_BASE64 | base64 --decode > profile.mobileprovision
    #     
    #     # í‚¤ì²´ì¸ì— ì¸ì¦ì„œ ì¶”ê°€
    #     security create-keychain -p "" build.keychain
    #     security import certificate.p12 -t agg -k build.keychain -P $IOS_CERTIFICATE_PASSWORD -A
    #     security list-keychains -s build.keychain
    #     security default-keychain -s build.keychain
    #     security unlock-keychain -p "" build.keychain
    #     
    #     # í”„ë¡œë¹„ì €ë‹ í”„ë¡œí•„ ì„¤ì¹˜
    #     mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
    #     cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

    - name: Configure code signing
      run: |
        cd ios/App
        # Development Team ì„¤ì •
        sed -i '' 's/DEVELOPMENT_TEAM = .*/DEVELOPMENT_TEAM = "5LCBBV4KNB";/g' App.xcodeproj/project.pbxproj
        echo "Development team configured"
        
    - name: Build iOS app
      run: |
        cd ios/App
        xcodebuild -workspace App.xcworkspace \
                   -scheme App \
                   -configuration Release \
                   -destination generic/platform=iOS \
                   -archivePath App.xcarchive \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO \
                   archive

    - name: Check Archive Success
      run: |
        cd ios/App
        if [ -d "App.xcarchive" ]; then
          echo "âœ… Archive ìƒì„± ì„±ê³µ!"
          ls -la App.xcarchive/
          ls -la App.xcarchive/Products/Applications/
        else
          echo "âŒ Archive ìƒì„± ì‹¤íŒ¨"
          exit 1
        fi

    - name: Create IPA without Code Signing
      run: |
        cd ios/App
        # Payload ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p Payload
    
        # App íŒŒì¼ì„ Payloadë¡œ ë³µì‚¬
        cp -r App.xcarchive/Products/Applications/App.app Payload/
    
        # IPA íŒŒì¼ ìƒì„± (ZIP ì••ì¶•)
        zip -r App-unsigned.ipa Payload/
    
        # ê²°ê³¼ í™•ì¸
        ls -la *.ipa
        echo "âœ… ë¬´ì„œëª… IPA íŒŒì¼ ìƒì„± ì™„ë£Œ!"

    - name: Export IPA (Development)
      run: |
        cd ios/App
        echo "ğŸ“‹ ExportOptions.plist í™•ì¸:"
        cat ../../ExportOptions.plist
    
        echo "ğŸ”¨ ê°œë°œìš© IPA Export ì‹œì‘..."
        xcodebuild -exportArchive \
                   -archivePath App.xcarchive \
                   -exportPath . \
                   -exportOptionsPlist ../../ExportOptions.plist \
                   -allowProvisioningUpdates

    - name: Check Export Result
      run: |
        cd ios/App
        ls -la *.ipa || echo "IPA íŒŒì¼ ì—†ìŒ"
        if [ -f "App.ipa" ]; then
          echo "âœ… ê°œë°œìš© IPA ìƒì„± ì„±ê³µ!"
          ls -lh App.ipa
        else
          echo "âŒ IPA ìƒì„± ì‹¤íŒ¨"
          ls -la
        fi

# Upload ë‹¨ê³„ë„ ì„ì‹œë¡œ ì£¼ì„ ì²˜ë¦¬  
# - name: Upload to App Store Connect

    - name: Debug Build Environment
      run: |
        echo "=== Xcode ë²„ì „ ==="
        xcodebuild -version
    
        echo "=== ì‚¬ìš© ê°€ëŠ¥í•œ SDK ==="
        xcodebuild -showsdks
    
        echo "=== í”„ë¡œì íŠ¸ ì •ë³´ ==="
        cd ios/App
        xcodebuild -list -workspace App.xcworkspace
    
        echo "=== ë¹Œë“œ ì„¤ì • í™•ì¸ ==="
        xcodebuild -workspace App.xcworkspace \
                   -scheme App \
                   -configuration Release \
                   -showBuildSettings | grep -i sign               
    - name: Export IPA
      run: |
        cd ios/App
        xcodebuild -exportArchive \
                   -archivePath App.xcarchive \
                   -exportPath . \
                   -exportOptionsPlist ../../ExportOptions.plist
                   
    - name: Upload to App Store Connect
      env:
        APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
      run: |
        # API í‚¤ íŒŒì¼ ìƒì„±
        echo "$APP_STORE_CONNECT_API_KEY" > AuthKey_$APP_STORE_CONNECT_KEY_ID.p8
    
        # App Store Connectì— ì—…ë¡œë“œ (ìƒˆë¡œìš´ ë°©ì‹)
        xcrun altool --upload-app \
                     --type ios \
                     --file ios/App/App.ipa \
                     --apiKey $APP_STORE_CONNECT_KEY_ID \
                     --apiIssuer $APP_STORE_CONNECT_ISSUER_ID \
                     --apiKeyPath ./AuthKey_$APP_STORE_CONNECT_KEY_ID.p8
