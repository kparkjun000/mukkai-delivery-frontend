name: iOS Build (No Code Signing)

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Capacitor iOS
      run: npm install @capacitor/ios

    - name: Build web app
      run: npm run build

    - name: Copy web assets to iOS
      run: |
        npx cap copy ios
        npx cap sync ios

    - name: Install CocoaPods dependencies
      run: |
        cd ios/App
        pod install

    - name: Debug Build Environment
      run: |
        echo "=== Xcode ë²„ì „ ==="
        xcodebuild -version
        
        echo "=== í”„ë¡œì íŠ¸ ì •ë³´ ==="
        cd ios/App
        xcodebuild -list -workspace App.xcworkspace

    - name: Build iOS Archive (No Signing)
      run: |
        cd ios/App
        echo "ğŸ”¨ ë¬´ì„œëª… Archive ë¹Œë“œ ì‹œì‘..."
        
        xcodebuild -workspace App.xcworkspace \
                   -scheme App \
                   -configuration Release \
                   -destination generic/platform=iOS \
                   -archivePath App.xcarchive \
                   CODE_SIGN_IDENTITY="" \
                   CODE_SIGNING_REQUIRED=NO \
                   CODE_SIGNING_ALLOWED=NO \
                   PROVISIONING_PROFILE="" \
                   archive
        
        echo "âœ… Archive ë¹Œë“œ ì™„ë£Œ!"

    - name: Create Unsigned IPA
      run: |
        cd ios/App
        
        echo "ğŸ“¦ Archive ë‚´ìš© í™•ì¸:"
        ls -la App.xcarchive/Products/Applications/
        
        echo "ğŸ”¨ ë¬´ì„œëª… IPA ìƒì„± ì¤‘..."
        
        # Payload í´ë” ìƒì„±
        mkdir -p Payload
        
        # App íŒŒì¼ì„ Payloadë¡œ ë³µì‚¬
        cp -r App.xcarchive/Products/Applications/App.app Payload/
        
        # IPA íŒŒì¼ ìƒì„±
        zip -r App-unsigned.ipa Payload/
        
        echo "âœ… ë¬´ì„œëª… IPA ìƒì„± ì™„ë£Œ!"
        ls -lh *.ipa

    - name: Verify IPA
      run: |
        cd ios/App
        echo "ğŸ“‹ IPA íŒŒì¼ ì •ë³´:"
        file App-unsigned.ipa
        
        echo "ğŸ“‹ IPA ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°:"
        unzip -l App-unsigned.ipa | head -20
        
        echo "ğŸ“ íŒŒì¼ í¬ê¸°:"
        du -h App-unsigned.ipa

    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-unsigned
        path: ios/App/App-unsigned.ipa
        retention-days: 30

    # ë‚˜ì¤‘ì— ì‚¬ìš©í•  App Store Connect ì—…ë¡œë“œ (í˜„ì¬ ë¹„í™œì„±í™”)
    # - name: Upload to App Store Connect
    #   if: false  # ì„ì‹œë¡œ ë¹„í™œì„±í™”
    #   env:
    #     APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
    #     APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
    #     APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
    #   run: |
    #     echo "App Store Connect ì—…ë¡œë“œëŠ” ë‚˜ì¤‘ì— í™œì„±í™” ì˜ˆì •"
